
var log = console.log;

module.exports = function(options) {
    var local = options.local;
    var excludes = local.excludes || [];
    var remote = options.remote;

    var script = 'rsync -';
    script += 'a'; // equivalent to -rlptgoD

    if (options['info'] === "percentage complete") {
        script += '--info=progress2';
    }
    else if (options['info'] === "verbose") {
        script += 'v'; // verbose information
    }

    // script += 'L'; // copy files that symlinks point to
    script += ' --delete';

    if (excludes.length > 0) {
        for (var z=0; z < excludes.length; z++) {
            script += ` --exclude=${require('./lib/escape')(excludes[z])}`
        }
    }

    script += ' --delete-excluded';
    script += ' --progress';
    script += ' --human-readable';
    script += ' -e';

    script += ' "ssh ';
    script += '-i ';
    script += remote.key + '" ';

    script += require('./escape')(local.directory) + '/ ';
    script += remote.user + '@';
    script += remote.address + ':';
    script += require('./escape')(remote.directory);

    const rsync = require('child_process').exec(script, {
        maxBuffer: 1024 * 5000
    }, (error, stdout, stderr) => {
        if (error) {
            log(`rsync error: ${error}`);
        }
    });
    rsync.stdout.on('data', function(data) {
        log(data);
    });
    rsync.stderr.on('data', function(data) {
        log(data)
    });
}
